<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ly≈æiarska ≈°kola ‚Äì Rezerv√°cie</title>
  <style>
    :root{
      --bg:#000; --fg:#fff; --card:#111; --border:#333;
      --free:#1a7f37; --reserved:#a00000; --selected:#ffd700; --primary:#008cba; --primaryH:#006f94;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui, Arial, sans-serif}
    .wrap{max-width:520px;margin:0 auto;padding:16px}
    h1{margin:8px 0 12px;text-align:center;font-size:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    label{font-size:14px;opacity:.9}
    input,select,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#111;color:#fff;font-size:16px}
    select, input[type="date"]{background:#151515}
    button.primary{background:var(--primary);border:none}
    button.primary:hover{background:var(--primaryH)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:12px;margin:8px 0 0}
    .dot{width:14px;height:14px;border-radius:6px;display:inline-block;border:1px solid #0003}
    .dot.free{background:var(--free)} .dot.sel{background:var(--selected)} .dot.res{background:var(--reserved)}
    .slots{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .slot{padding:12px;border:none;border-radius:12px;text-align:center;font-weight:600}
    .slot.free{background:var(--free);color:#fff}
    .slot.reserved{background:var(--reserved);color:#fff;opacity:.9}
    .slot.selected{background:var(--selected);color:#000}
    .slot.reserved:disabled{cursor:not-allowed}
    .section{margin-top:14px}
    .footer{margin:24px 0 12px;text-align:center;color:#9aa}
    .footer a{color:#9aa;text-decoration:none;margin:0 8px}
    /* Cenn√≠k modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:50;justify-content:center;align-items:center;padding:16px}
    .modal .content{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:420px;width:100%;padding:16px;position:relative}
    .modal h3{margin:0 0 8px}
    .closeX{position:absolute;right:12px;top:10px;background:transparent;border:none;color:#fff;font-size:20px}
    .summary{margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Rezerv√°cia lekcie</h1>

    <div class="card section">
      <div class="row">
        <div>
          <label for="date">D√°tum</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label for="sport">Typ lekcie</label>
          <select id="sport">
            <option value="lyze">Ly≈æe</option>
            <option value="snb">Snowboard</option>
          </select>
        </div>
      </div>

      <div class="legend">
        <span><i class="dot free"></i> Voƒæn√©</span>
        <span><i class="dot sel"></i> Vybrat√©</span>
        <span><i class="dot res"></i> Zarezervovan√©</span>
      </div>

      <div id="slots" class="slots" aria-live="polite"></div>

      <div class="row section">
        <button id="openPrice" class="primary" type="button">üìã Cenn√≠k</button>
        <button id="clearSel" type="button">Vymaza≈• v√Ωber</button>
      </div>
    </div>

    <form id="reserveForm" class="card section">
      <h3 style="margin-top:0">Rezervaƒçn√Ω formul√°r</h3>
      <label for="name">Meno a priezvisko</label>
      <input id="name" required />

      <label for="phone">Telef√≥n</label>
      <input id="phone" type="tel" required />

      <label for="email">Email</label>
      <input id="email" type="email" required />

      <label for="note">Pozn√°mka</label>
      <textarea id="note" rows="2" placeholder="Dobrovoƒæn√©"></textarea>

      <button class="primary" type="submit">Rezervova≈• vybrat√© hodiny</button>
      <div id="summary" class="summary"></div>
    </form>

    <div class="footer">
      ¬© 2025 Ly≈æiarska ≈°kola
      <a href="admin.html" aria-label="Admin rezerv√°ci√≠">Admin</a> ‚Ä¢
      <a href="cennik-admin.html" aria-label="Admin cenn√≠ka">Cenn√≠k-Admin</a>
    </div>
  </div>

  <!-- Modal Cenn√≠k -->
  <div id="priceModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="priceTitle">
    <div class="content">
      <button class="closeX" id="closePrice" aria-label="Zavrie≈•">‚úï</button>
      <h3 id="priceTitle">Cenn√≠k</h3>
      <div id="priceContent">Naƒç√≠tavam‚Ä¶</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, runTransaction,
      collection, addDoc, serverTimestamp,
      arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // TODO: vlo≈æ sem svoj Firebase config (presne ako ti ho d√° konzola)
    const firebaseConfig = {
      apiKey: "AIzaSyCf1STUPCcqzuTefIgo2Rca49vpNJY4",
      authDomain: "lyziarska-skola.firebaseapp.com",
      projectId: "lyziarska-skola",
      storageBucket: "lyziarska-skola.appspot.com",
      messagingSenderId: "59575233692",
      appId: "1:59575233692:web:c84584d064fc8a79db59",
      measurementId: "G-KRT4ECRERK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ƒåasov√© sloty
    const SLOTS = [
      "09:00 - 09:55","10:00 - 10:55","11:00 - 11:55","12:00 - 12:55",
      "13:30 - 14:25","14:30 - 15:25","15:30 - 16:25","16:30 - 17:25",
      "17:30 - 18:25","18:30 - 19:25"
    ];

    const dateEl = document.getElementById("date");
    const sportEl = document.getElementById("sport");
    const slotsEl = document.getElementById("slots");
    const clearSelBtn = document.getElementById("clearSel");
    const form = document.getElementById("reserveForm");
    const summaryEl = document.getElementById("summary");

    // Modal Cenn√≠k
    const priceModal = document.getElementById("priceModal");
    const openPrice = document.getElementById("openPrice");
    const closePrice = document.getElementById("closePrice");
    const priceContent = document.getElementById("priceContent");

    let selected = new Set();
    let reservedToday = new Set();
    let currentKey = ""; // date_sport

    const today = new Date().toISOString().slice(0,10);
    dateEl.value = today;

    function keyFor(date, sport){ return `${date}_${sport}`; }
    function btn(label, cls){ const b=document.createElement("button"); b.type="button"; b.textContent=label; b.className=`slot ${cls}`; return b; }

    async function loadSlots(){
      selected.clear();
      slotsEl.innerHTML = "";
      summaryEl.innerHTML = "";
      const date = dateEl.value;
      const sport = sportEl.value;
      currentKey = keyFor(date, sport);
      reservedToday = new Set();

      // naƒç√≠taj rezervovan√© times pre dan√Ω de≈à/≈°port
      const kalRef = doc(db, "kalendar", currentKey);
      const snap = await getDoc(kalRef);
      const reservedArr = snap.exists() ? (snap.data().reservedTimes || []) : [];
      reservedArr.forEach(t => reservedToday.add(t));

      // vykresli sloty
      SLOTS.forEach(time => {
        const isReserved = reservedToday.has(time);
        const b = isReserved ? btn(time, "reserved") : btn(time, "free");
        if (isReserved) {
          b.disabled = true;
          b.setAttribute("aria-disabled","true");
          b.title = "Zarezervovan√©";
        } else {
          b.addEventListener("click", () => {
            if (selected.has(time)) {
              selected.delete(time);
              b.classList.remove("selected");
              b.classList.add("free");
            } else {
              selected.add(time);
              b.classList.remove("free");
              b.classList.add("selected");
            }
          });
        }
        slotsEl.appendChild(b);
      });
    }

    function ensureAtLeastOne(){
      if (selected.size===0){ alert("Vyber aspo≈à jednu hodinu."); return false; }
      return true;
    }

    clearSelBtn.addEventListener("click", ()=>{ selected.clear(); loadSlots(); });

    dateEl.addEventListener("change", loadSlots);
    sportEl.addEventListener("change", loadSlots);

    // Rezerv√°cia s bezpeƒçn√Ωm ulo≈æen√≠m slotov (transakcia)
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!ensureAtLeastOne()) return;

      const payload = {
        date: dateEl.value,
        sport: sportEl.value,
        name: document.getElementById("name").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        email: document.getElementById("email").value.trim(),
        note: document.getElementById("note").value.trim(),
        slots: Array.from(selected),
        createdAt: serverTimestamp()
      };

      const kalRef = doc(db, "kalendar", currentKey);

      try {
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(kalRef);
          const already = snap.exists() ? (snap.data().reservedTimes || []) : [];
          // konflikt?
          const conflicts = payload.slots.filter(s => already.includes(s));
          if (conflicts.length){
            throw new Error("Niektor√© vybran√© ƒçasy u≈æ medzit√Ωm niekto obsadil: " + conflicts.join(", "));
          }
          // zap√≠≈° rezerv√°ciu slotov
          if (snap.exists()){
            tx.update(kalRef, { reservedTimes: arrayUnion(...payload.slots) });
          } else {
            tx.set(kalRef, { reservedTimes: arrayUnion(...payload.slots) }, { merge: true });
          }
        });

        // a≈æ po √∫spe≈°nej transakcii ulo≈æ detail rezerv√°cie
        await addDoc(collection(db, "rezervacie"), payload);

        summaryEl.innerHTML =
          `<div class="card" style="margin-top:10px">
            <strong>‚úÖ Rezerv√°cia √∫spe≈°n√°</strong><br/>
            D√°tum: ${payload.date}<br/>
            Typ: ${payload.sport === "lyze" ? "Ly≈æe" : "Snowboard"}<br/>
            Hodiny: ${payload.slots.join(", ")}
          </div>`;

        form.reset();
        selected.clear();
        await loadSlots();
      } catch (err){
        alert(err.message || "Rezerv√°ciu sa nepodarilo dokonƒçi≈•.");
        await loadSlots();
      }
    });

    // CENN√çK ‚Äì naƒç√≠tanie z Firestore (cennik/default)
    async function loadPrice(){
      priceContent.textContent = "Naƒç√≠tavam‚Ä¶";
      const ref = doc(db, "cennik", "default");
      const snap = await getDoc(ref);
      if (!snap.exists()){
        priceContent.innerHTML = "<p>‚ö†Ô∏è Cenn√≠k zatiaƒæ nie je nastaven√Ω.</p>";
        return;
      }
      const c = snap.data();
      priceContent.innerHTML = `
        <div class="card">
          <p><strong>1 hodina individu√°lna:</strong> ${c.hodina_individualna || "-"}</p>
          <p><strong>2 osoby spolu:</strong> ${c.dve_osoby || "-"}</p>
          <p><strong>Skupina (3‚Äì6 os√¥b):</strong> ${c.skupina || "-"}</p>
          <p><strong>Deti do 6 rokov:</strong> ${c.deti || "-"}</p>
        </div>`;
    }

    openPrice.addEventListener("click", async ()=>{
      await loadPrice();
      priceModal.style.display = "flex";
    });
    closePrice.addEventListener("click", ()=> priceModal.style.display="none");
    priceModal.addEventListener("click", (e)=>{ if (e.target===priceModal) priceModal.style.display="none"; });

    // init
    loadSlots();
  </script>
</body>
</html>
