<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rezervácia lyžiarskej školy</title>
  <script type="module">
    // Firebase import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Tvoj config
    const firebaseConfig = {
      apiKey: "AIzaSyCf1STUPCcqzuTefIgo2Rca49vpNJY4",
      authDomain: "lyziarska-skola.firebaseapp.com",
      projectId: "lyziarska-skola",
      storageBucket: "lyziarska-skola.appspot.com",
      messagingSenderId: "59575233692",
      appId: "1:59575233692:web:c84584d064fc8a79db59",
      measurementId: "G-KRT4ECRERK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Časy lekcií
    const slots = [
      "09:00 - 09:55", "10:00 - 10:55", "11:00 - 11:55", "12:00 - 12:55",
      "13:30 - 14:25", "14:30 - 15:25", "15:30 - 16:25", "16:30 - 17:25",
      "17:30 - 18:25", "18:30 - 19:25"
    ];

    let selectedSlots = [];

    // Funkcia na vykreslenie časov
    async function renderSlots(date) {
      const container = document.getElementById("slots");
      container.innerHTML = "";

      const docRef = doc(db, "rezervacie", date);
      const docSnap = await getDoc(docRef);

      let booked = [];
      if (docSnap.exists()) {
        booked = docSnap.data().bookedSlots || [];
      }

      slots.forEach(time => {
        const div = document.createElement("div");
        div.textContent = time;
        div.classList.add("slot");

        if (booked.includes(time)) {
          div.classList.add("booked"); // červená
        } else {
          div.classList.add("free"); // zelená
          div.addEventListener("click", () => toggleSlot(time, div));
        }

        container.appendChild(div);
      });
    }

    function toggleSlot(time, div) {
      if (selectedSlots.includes(time)) {
        selectedSlots = selectedSlots.filter(t => t !== time);
        div.classList.remove("selected");
      } else {
        selectedSlots.push(time);
        div.classList.add("selected");
      }
    }

    // Rezervácia
    document.addEventListener("DOMContentLoaded", () => {
      const dateInput = document.getElementById("date");
      dateInput.addEventListener("change", () => {
        selectedSlots = [];
        renderSlots(dateInput.value);
      });

      document.getElementById("bookingForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("name").value;
        const phone = document.getElementById("phone").value;
        const email = document.getElementById("email").value;
        const note = document.getElementById("note").value;
        const sport = document.getElementById("sport").value;
        const date = dateInput.value;

        if (!date || selectedSlots.length === 0) {
          alert("Vyberte dátum a aspoň jednu hodinu!");
          return;
        }

        const docRef = doc(db, "rezervacie", date);
        const docSnap = await getDoc(docRef);

        let booked = [];
        if (docSnap.exists()) {
          booked = docSnap.data().bookedSlots || [];
        }

        // Overenie konfliktov
        const conflict = selectedSlots.some(s => booked.includes(s));
        if (conflict) {
          alert("Niektorý z vybraných časov je už obsadený!");
          return;
        }

        // Uloženie do databázy
        await setDoc(docRef, {
          date: date,
          createdAt: new Date(),
          bookedSlots: [...booked, ...selectedSlots],
          reservations: docSnap.exists()
            ? [...(docSnap.data().reservations || []), { name, phone, email, note, sport, slots: selectedSlots }]
            : [{ name, phone, email, note, sport, slots: selectedSlots }]
        });

        alert("Rezervácia uložená!");
        renderSlots(date);
        e.target.reset();
        selectedSlots = [];
      });
    });
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 { margin-bottom: 20px; }
    #slots {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 20px 0;
    }
    .slot {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #444;
    }
    .free { background: green; color: white; }
    .selected { background: yellow; color: black; }
    .booked { background: red; color: white; cursor: not-allowed; }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    input, select, textarea, button {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
    }
    button {
      background: teal;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #008080cc; }
    #priceBtn {
      margin-top: 15px;
      background: #555;
    }
  </style>
</head>
<body>
  <h1>Rezervácia lyžiarskej školy</h1>

  <label for="date">Vyber dátum:</label>
  <input type="date" id="date">

  <div id="slots"></div>

  <form id="bookingForm">
    <input type="text" id="name" placeholder="Meno a priezvisko" required>
    <input type="tel" id="phone" placeholder="Telefón" required>
    <input type="email" id="email" placeholder="Email" required>
    <textarea id="note" placeholder="Poznámka"></textarea>
    <select id="sport" required>
      <option value="ski">Lyže</option>
      <option value="snb">Snowboard</option>
    </select>
    <button type="submit">Rezervovať</button>
  </form>

  <button id="priceBtn" onclick="window.location.href='cennik.html'">Cenník</button>
</body>
</html>
