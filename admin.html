<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin – Rezervácie</title>
  <style>
    :root{--bg:#000;--fg:#fff;--card:#111;--border:#333;--danger:#a00000;--btn:#444}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Arial,sans-serif}
    .wrap{max-width:780px;margin:0 auto;padding:16px}
    h1{margin:8px 0 12px;text-align:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#111;color:#fff}
    button.danger{background:var(--danger);border:none}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid var(--border);padding:8px;text-align:center;font-size:14px}
    th{background:#0f0f0f}
    .muted{opacity:.7;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin – Rezervácie</h1>

    <div class="card">
      <div class="row">
        <div>
          <label for="fDate" class="muted">Filter dátumu</label>
          <input id="fDate" type="date">
        </div>
        <div>
          <label for="fSport" class="muted">Šport</label>
          <select id="fSport">
            <option value="">Všetko</option>
            <option value="lyze">Lyže</option>
            <option value="snb">Snowboard</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:end">
          <button id="reload">Načítať</button>
          <button id="clear" class="danger">Reset filtrov</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Dátum</th><th>Šport</th><th>Meno</th><th>Tel</th><th>Email</th><th>Pozn.</th><th>Hodiny</th><th>Akcia</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="muted" style="text-align:center;margin-top:10px">Po zmazaní rezervácie sa sloty automaticky uvoľnia.</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, orderBy,
      doc, runTransaction, deleteDoc, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // TODO: vlož sem svoj Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCf1STUPCcqzuTefIgo2Rca49vpNJY4",
      authDomain: "lyziarska-skola.firebaseapp.com",
      projectId: "lyziarska-skola",
      storageBucket: "lyziarska-skola.appspot.com",
      messagingSenderId: "59575233692",
      appId: "1:59575233692:web:c84584d064fc8a79db59",
      measurementId: "G-KRT4ECRERK"
    };

    // jednoduchý "login"
    const ADMIN_PASSWORD = "tajneheslo123"; // zmeň si!
    const entered = prompt("Zadaj admin heslo:");
    if (entered !== ADMIN_PASSWORD) {
      document.body.innerHTML = "<h2 style='color:#fff;text-align:center;margin-top:30px'>Neoprávnený prístup ❌</h2>";
      throw new Error("Unauthorized");
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tbody = document.getElementById("tbody");
    const fDate = document.getElementById("fDate");
    const fSport = document.getElementById("fSport");
    const reloadBtn = document.getElementById("reload");
    const clearBtn = document.getElementById("clear");

    reloadBtn.addEventListener("click", load);
    clearBtn.addEventListener("click", ()=>{
      fDate.value = ""; fSport.value = ""; load();
    });

    async function load(){
      tbody.innerHTML = "<tr><td colspan='8'>Načítavam…</td></tr>";
      let qRef = collection(db, "rezervacie");
      const filters = [];
      if (fDate.value) filters.push(where("date","==", fDate.value));
      if (fSport.value) filters.push(where("sport","==", fSport.value));
      if (filters.length){
        qRef = query(qRef, ...filters, orderBy("date","asc"));
      } else {
        qRef = query(qRef, orderBy("date","asc"));
      }
      const snap = await getDocs(qRef);
      tbody.innerHTML = "";
      if (snap.empty){ tbody.innerHTML = "<tr><td colspan='8'>Žiadne rezervácie</td></tr>"; return; }

      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.date}</td>
          <td>${d.sport}</td>
          <td>${d.name}</td>
          <td>${d.phone}</td>
          <td>${d.email}</td>
          <td>${d.note || ""}</td>
          <td>${(d.slots||[]).join(", ")}</td>
          <td><button class="danger" data-id="${docSnap.id}">Zmazať</button></td>
        `;
        tbody.appendChild(tr);
      });

      // bind delete
      tbody.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.addEventListener("click", ()=> removeReservation(btn.dataset.id));
      });
    }

    async function removeReservation(resId){
      if (!confirm("Naozaj zmazať rezerváciu a uvoľniť časy?")) return;
      // potrebujeme načítať rezerváciu pre dáta
      const listSnap = await getDocs(query(collection(db,"rezervacie"), where("__name__","==",resId)));
      if (listSnap.empty) return;
      const resDoc = listSnap.docs[0];
      const d = resDoc.data();
      const kalKey = `${d.date}_${d.sport}`;
      const kalRef = doc(db, "kalendar", kalKey);

      try{
        await runTransaction(db, async (tx)=>{
          // uvoľni sloty
          tx.update(kalRef, { reservedTimes: arrayRemove(...(d.slots||[])) });
          // zmaž rezerváciu
          tx.delete(resDoc.ref);
        });
      } catch(e){
        // ak kalendar dokument ešte neexistuje (okrajovo), skús aspoň zmazať rezerváciu
        await deleteDoc(resDoc.ref);
      }
      await load();
    }

    load();
  </script>
</body>
</html>
