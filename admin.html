<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Rezerv√°cie</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      padding: 20px;
      background: #000;
      margin: 0;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }

    .filters {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    @media(min-width: 600px) {
      .filters {
        flex-direction: row;
        justify-content: space-between;
      }
    }

    input, select, button, textarea {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #222;
      color: #fff;
      cursor: pointer;
    }

    button:hover {
      background: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #333;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background: #222;
    }

    tr:hover {
      background: #1e1e1e;
    }

    .delete-btn {
      background: red;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }

    .export-btn {
      background: green;
      margin-left: 10px;
    }

    .save-btn {
      background: dodgerblue;
      margin-left: 5px;
    }

    .action-group {
      display: flex;
      gap: 5px;
    }

    .no-data {
      text-align: center;
      padding: 20px;
      color: #aaa;
    }

    .note-input {
      width: 100%;
      resize: vertical;
      min-height: 40px;
    }
  </style>
</head>
<body>
  <h1>üìã Admin - Rezerv√°cie</h1>
  <div class="container">

    <!-- Filtre -->
    <div class="filters">
      <div>
        <label for="filterDate">D√°tum</label><br>
        <input type="date" id="filterDate">
      </div>
      <div>
        <label for="filterSport">Typ lekcie</label><br>
        <select id="filterSport">
          <option value="">V≈°etko</option>
          <option value="lyze">Ly≈æe</option>
          <option value="snb">Snowboard</option>
        </select>
      </div>
      <div>
        <button onclick="loadReservations()">üîÑ Obnovi≈•</button>
        <button class="export-btn" onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
      </div>
    </div>

    <!-- Tabuƒæka rezerv√°ci√≠ -->
    <table>
      <thead>
        <tr>
          <th>D√°tum</th>
          <th>≈†port</th>
          <th>Meno</th>
          <th>Telef√≥n</th>
          <th>Email</th>
          <th>Hodiny</th>
          <th>Pozn√°mka z√°kazn√≠ka</th>
          <th>Intern√° pozn√°mka</th>
          <th>Akcia</th>
        </tr>
      </thead>
      <tbody id="reservationTable"></tbody>
    </table>

    <div id="noData" class="no-data" style="display:none;">≈Ωiadne rezerv√°cie</div>
  </div>

  <script>
    // üîí jednoduch√° ochrana heslom
    (function() {
      const pwd = prompt("Zadajte heslo pre pr√≠stup do adminu:");
      if (pwd !== "tajneheslo") {
        alert("Nespr√°vne heslo!");
        document.body.innerHTML = "<h2 style='color:red; text-align:center; margin-top:50px;'>‚ùå Pr√≠stup zamietnut√Ω</h2>";
        throw new Error("Unauthorized");
      }
    })();

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCf1STUPCcqzuTefIgo2Rca49vpNJY4",
      authDomain: "lyziarska-skola.firebaseapp.com",
      projectId: "lyziarska-skola",
      storageBucket: "lyziarska-skola.appspot.com",
      messagingSenderId: "59575233692",
      appId: "1:59575233692:web:c84584d064fc8a79db59",
      measurementId: "G-KRT4ECRERK"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const reservationTable = document.getElementById("reservationTable");
    const noDataDiv = document.getElementById("noData");

    let lastSnapshot = []; // ulo≈æ√≠ posledne naƒç√≠tan√© d√°ta (na export)

    // naƒç√≠tanie rezerv√°ci√≠
    async function loadReservations() {
      reservationTable.innerHTML = "";
      noDataDiv.style.display = "none";
      lastSnapshot = [];

      let query = db.collection("rezervacie");

      const filterDate = document.getElementById("filterDate").value;
      const filterSport = document.getElementById("filterSport").value;

      if (filterDate) {
        query = query.where("date", "==", filterDate);
      }
      if (filterSport) {
        query = query.where("sport", "==", filterSport);
      }

      const snapshot = await query.get();

      if (snapshot.empty) {
        noDataDiv.style.display = "block";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        lastSnapshot.push({ id: doc.id, ...data });
      });

      // üîÑ zoradenie podƒæa ƒçasu vytvorenia (najnov≈°ie hore)
      lastSnapshot.sort((a, b) => {
        return (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0);
      });

      // vykreslenie tabuƒæky
      lastSnapshot.forEach(res => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${res.date}</td>
          <td>${res.sport}</td>
          <td>${res.name}</td>
          <td>${res.phone}</td>
          <td>${res.email}</td>
          <td>${(res.slots || []).join(", ")}</td>
          <td>${res.customerNote || ""}</td>
          <td>
            <textarea class="note-input" id="note-${res.id}">${res.adminNote || ""}</textarea>
          </td>
          <td class="action-group">
            <button class="save-btn" onclick="saveNote('${res.id}')">üíæ</button>
            <button class="delete-btn" onclick="deleteReservation('${res.id}')">‚ùå</button>
          </td>
        `;
        reservationTable.appendChild(tr);
      });
    }

    // ulo≈æenie internej pozn√°mky
    async function saveNote(id) {
      const noteValue = document.getElementById("note-" + id).value;
      await db.collection("rezervacie").doc(id).update({ adminNote: noteValue });
      alert("‚úÖ Intern√° pozn√°mka ulo≈æen√°!");
    }

    // vymazanie rezerv√°cie
    async function deleteReservation(id) {
      if (confirm("Naozaj chcete vymaza≈• t√∫to rezerv√°ciu?")) {
        await db.collection("rezervacie").doc(id).delete();
        loadReservations();
      }
    }

    // export do CSV
    function exportCSV() {
      if (lastSnapshot.length === 0) {
        alert("≈Ωiadne d√°ta na export!");
        return;
      }

      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "D√°tum;≈†port;Meno;Telef√≥n;Email;Hodiny;Pozn√°mka z√°kazn√≠ka;Intern√° pozn√°mka\n";

      lastSnapshot.forEach(res => {
        csvContent += `${res.date};${res.sport};${res.name};${res.phone};${res.email};"${(res.slots || []).join(", ")}";${res.customerNote || ""};${res.adminNote || ""}\n`;
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "rezervacie.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // naƒç√≠ta≈• po otvoren√≠
    window.onload = loadReservations;
  </script>
</body>
</html>
